<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fractal Grove</title>
  <style>
    :root {
      --ink: #0c2c1f;
      --leaf: #3da35d;
      --sky: #b4e0e1;
      --amber: #f2b880;
      --stone: #0f1414;
      --panel: rgba(15, 20, 20, 0.72);
      --accent: #d8f8c6;
      --font: "Palatino Linotype", "Book Antiqua", Palatino, serif;
    }
    * { box-sizing: border-box; }
    html, body { margin:0; height:100%; background: radial-gradient(120% 120% at 20% 20%, #0b1c1a, #06100e 45%, #040807 80%); color: var(--accent); font-family: var(--font); }
    #gl { width:100%; height:100%; display:block; }
    .hud { position:fixed; top:0; left:0; right:0; pointer-events:none; padding:1.5rem; display:flex; justify-content:space-between; gap:1rem; align-items:flex-start; }
    .card { background: var(--panel); border:1px solid rgba(216, 248, 198, 0.15); border-radius: 16px; padding: 1rem 1.25rem; box-shadow: 0 20px 60px rgba(0,0,0,0.35); pointer-events:auto; backdrop-filter: blur(10px); }
    .title { font-size:1.3rem; letter-spacing:0.08em; text-transform:uppercase; color: var(--sky); margin:0 0 0.25rem 0; }
    .subtitle { margin:0 0 0.75rem 0; color: #cde5d7; font-size: 0.95rem; max-width: 28rem; line-height: 1.5; }
    .controls { display:grid; grid-template-columns: repeat(2, minmax(140px,1fr)); gap:0.75rem; }
    .row { display:flex; align-items:center; gap:0.5rem; font-size:0.95rem; }
    label { color: #d9f4da; font-weight:600; letter-spacing:0.03em; }
    input[type=range] { width:100%; accent-color: var(--leaf); }
    button { background: linear-gradient(135deg, var(--leaf), #1f6a3a); color: #f5ffe8; border: none; border-radius: 10px; padding: 0.55rem 0.85rem; font-weight:700; letter-spacing:0.03em; cursor:pointer; transition: transform 120ms ease, box-shadow 120ms ease; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    button:hover { transform: translateY(-2px); box-shadow: 0 14px 36px rgba(0,0,0,0.4); }
    button:active { transform: translateY(0); }
    .legend { position:fixed; bottom:1.25rem; left:1.25rem; color:#c4e9d2; font-size:0.9rem; background: rgba(6,12,10,0.55); padding:0.65rem 0.85rem; border-radius: 12px; border:1px solid rgba(216, 248, 198, 0.12); pointer-events:none; }
    @media (max-width: 820px) {
      .hud { flex-direction:column; align-items:flex-start; }
      .controls { grid-template-columns: repeat(1, minmax(220px,1fr)); width: 100%; }
    }
  </style>
</head>
<body>
<canvas id="gl"></canvas>
<div class="hud">
  <div class="card">
    <p class="title">Fractal Grove</p>
    <p class="subtitle">Glide through a living Mandelbrot & Julia field. Scroll to zoom, drag to roam. Nature weaves itself in endless echoes.</p>
    <div class="controls">
      <div class="row">
        <label for="iter">Iterations</label>
        <input id="iter" type="range" min="64" max="1000" step="8" value="420">
      </div>
      <div class="row">
        <label for="palette">Palette</label>
        <input id="palette" type="range" min="0" max="6.283" step="0.001" value="0.0">
      </div>
      <div class="row">
        <label for="julia">Julia seed</label>
        <input id="julia" type="range" min="-1.5" max="1.5" step="0.001" value="-0.4">
      </div>
      <button id="toggle">Switch to Julia</button>
      <button id="reset">Reset View</button>
      <button id="save">Save Frame</button>
    </div>
  </div>
</div>
<div class="legend">Scroll to zoom � Drag to pan � Shift+Drag to rotate palette</div>
<script>
(() => {
  const canvas = document.getElementById('gl');
  const gl = canvas.getContext('webgl');
  if (!gl) {
    alert('WebGL required. Enable it to explore the grove.');
    return;
  }

  const vertSrc = `
    attribute vec2 position;
    void main() { gl_Position = vec4(position, 0.0, 1.0); }
  `;

  const fragSrc = `
    precision highp float;
    uniform vec2 u_resolution;
    uniform vec2 u_center;
    uniform float u_scale;
    uniform float u_time;
    uniform float u_palette;
    uniform int u_mode; // 0 = Mandelbrot, 1 = Julia
    uniform vec2 u_julia;
    uniform int u_iter;

    vec3 palette(float t) {
      vec3 a = vec3(0.08, 0.14, 0.06);
      vec3 b = vec3(0.75, 0.85, 0.45);
      vec3 c = vec3(0.18, 0.33, 0.75);
      vec3 d = vec3(0.00, 0.33, 0.67);
      return a + b * cos(6.28318 * (c * t + d + u_palette));
    }

    void main() {
      vec2 uv = (gl_FragCoord.xy - 0.5 * u_resolution) / u_resolution.y;
      vec2 c = u_center + uv * u_scale;
      vec2 z = c;
      if (u_mode == 1) { c = u_julia; }

      float iter = 0.0;
      float maxIter = float(u_iter);
      for (int i = 0; i < 1200; ++i) {
        if (float(i) >= maxIter) break;
        float x = (z.x * z.x - z.y * z.y) + c.x;
        float y = (2.0 * z.x * z.y) + c.y;
        z = vec2(x, y);
        if (dot(z, z) > 4.0) { iter = float(i); break; }
        iter = maxIter;
      }

      float smooth = iter;
      if (iter < maxIter) {
        float log_zn = log(dot(z, z)) / 2.0;
        float nu = log(log_zn / log(2.0)) / log(2.0);
        smooth = iter + 1.0 - nu;
      }
      float t = smooth / maxIter;
      vec3 col = palette(t + 0.03 * sin(0.2 * u_time)) * exp(-0.6 * pow(t, 0.65));
      col = mix(col, vec3(0.02, 0.05, 0.04), smooth == maxIter ? 0.8 : 0.15);
      gl_FragColor = vec4(col, 1.0);
    }
  `;

  function compile(type, src) {
    const s = gl.createShader(type);
    gl.shaderSource(s, src);
    gl.compileShader(s);
    if (!gl.getShaderParameter(s, gl.COMPILE_STATUS)) {
      console.error(gl.getShaderInfoLog(s));
      throw new Error('Shader compile fail');
    }
    return s;
  }

  const program = gl.createProgram();
  gl.attachShader(program, compile(gl.VERTEX_SHADER, vertSrc));
  gl.attachShader(program, compile(gl.FRAGMENT_SHADER, fragSrc));
  gl.linkProgram(program);
  if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
    console.error(gl.getProgramInfoLog(program));
    throw new Error('Program link fail');
  }
  gl.useProgram(program);

  const quad = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, quad);
  gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
    -1, -1,  1, -1,  -1, 1,
    -1,  1,  1, -1,   1, 1
  ]), gl.STATIC_DRAW);
  const loc = gl.getAttribLocation(program, 'position');
  gl.enableVertexAttribArray(loc);
  gl.vertexAttribPointer(loc, 2, gl.FLOAT, false, 0, 0);

  const uni = {
    resolution: gl.getUniformLocation(program, 'u_resolution'),
    center: gl.getUniformLocation(program, 'u_center'),
    scale: gl.getUniformLocation(program, 'u_scale'),
    time: gl.getUniformLocation(program, 'u_time'),
    palette: gl.getUniformLocation(program, 'u_palette'),
    mode: gl.getUniformLocation(program, 'u_mode'),
    julia: gl.getUniformLocation(program, 'u_julia'),
    iter: gl.getUniformLocation(program, 'u_iter'),
  };

  let state = {
    center: { x: -0.5, y: 0.0 },
    scale: 3.0,
    palette: 0.0,
    mode: 0,
    julia: { x: -0.4, y: 0.6 },
    iter: 420,
  };

  const iterSlider = document.getElementById('iter');
  const paletteSlider = document.getElementById('palette');
  const juliaSlider = document.getElementById('julia');
  const toggle = document.getElementById('toggle');
  const reset = document.getElementById('reset');
  const save = document.getElementById('save');

  iterSlider.addEventListener('input', () => state.iter = parseInt(iterSlider.value, 10));
  paletteSlider.addEventListener('input', () => state.palette = parseFloat(paletteSlider.value));
  juliaSlider.addEventListener('input', () => state.julia.x = Math.max(-1.5, Math.min(1.5, parseFloat(juliaSlider.value))));
  toggle.addEventListener('click', () => {
    state.mode = 1 - state.mode;
    toggle.textContent = state.mode === 0 ? 'Switch to Julia' : 'Switch to Mandelbrot';
  });
  reset.addEventListener('click', () => {
    state = { center: { x: -0.5, y: 0.0 }, scale: 3.0, palette: 0.0, mode: 0, julia: { x: -0.4, y: 0.6 }, iter: 420 };
    iterSlider.value = state.iter;
    paletteSlider.value = state.palette;
    juliaSlider.value = state.julia.x;
    toggle.textContent = 'Switch to Julia';
  });
  save.addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = 'fractal-grove.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });

  let dragging = false;
  let last = { x: 0, y: 0 };
  canvas.addEventListener('mousedown', e => { dragging = true; last = { x: e.clientX, y: e.clientY }; });
  window.addEventListener('mouseup', () => dragging = false);
  window.addEventListener('mousemove', e => {
    if (!dragging) return;
    const dx = e.clientX - last.x;
    const dy = e.clientY - last.y;
    const scale = state.scale / canvas.height;
    state.center.x -= dx * scale;
    state.center.y += dy * scale;
    if (e.shiftKey) state.palette += dx * 0.005;
    last = { x: e.clientX, y: e.clientY };
  });

  canvas.addEventListener('wheel', e => {
    e.preventDefault();
    const zoom = Math.exp(-e.deltaY * 0.0015);
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left - 0.5 * canvas.width) / canvas.height;
    const y = (e.clientY - rect.top - 0.5 * canvas.height) / canvas.height;
    state.center.x += x * state.scale * (1.0 - zoom);
    state.center.y -= y * state.scale * (1.0 - zoom);
    state.scale *= zoom;
  }, { passive: false });

  function resize() {
    const dpr = window.devicePixelRatio || 1;
    const w = Math.floor(window.innerWidth * dpr);
    const h = Math.floor(window.innerHeight * dpr);
    if (canvas.width !== w || canvas.height !== h) {
      canvas.width = w; canvas.height = h;
    }
    canvas.style.width = '100%';
    canvas.style.height = '100%';
    gl.viewport(0, 0, canvas.width, canvas.height);
  }
  window.addEventListener('resize', resize);
  resize();

  let start = performance.now();
  function frame(now) {
    const t = (now - start) * 0.001;
    gl.uniform2f(uni.resolution, canvas.width, canvas.height);
    gl.uniform2f(uni.center, state.center.x, state.center.y);
    gl.uniform1f(uni.scale, state.scale);
    gl.uniform1f(uni.time, t);
    gl.uniform1f(uni.palette, state.palette);
    gl.uniform1i(uni.mode, state.mode);
    gl.uniform2f(uni.julia, state.julia.x, state.julia.y);
    gl.uniform1i(uni.iter, state.iter);
    gl.drawArrays(gl.TRIANGLES, 0, 6);
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
})();
</script>
</body>
</html>
